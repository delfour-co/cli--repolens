name: Sync Wiki

on:
  push:
    branches: [main, master]
    paths:
      - 'wiki/**'
      - 'README.md'
      - 'DEVELOPMENT.md'
      - 'CHANGELOG.md'
      - '.github/workflows/sync-wiki.yml'
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

permissions:
  contents: write  # NÃ©cessaire pour pousser vers le WIKI

jobs:
  sync-wiki:
    name: Synchroniser le WIKI
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour avoir l'historique Git complet
      
      - name: Configurer Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: VÃ©rifier que le WIKI est activÃ©
        id: check-wiki
        run: |
          REPO="${{ github.repository }}"
          WIKI_REPO="${REPO}.wiki"
          
          # VÃ©rifier si le WIKI existe
          if git ls-remote "https://github.com/${WIKI_REPO}.git" &>/dev/null; then
            echo "wiki_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… WIKI trouvÃ©: ${WIKI_REPO}"
          else
            echo "wiki_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  WIKI non trouvÃ©: ${WIKI_REPO}"
            echo "âš ï¸  Activez le WIKI dans Settings > Features > Wikis"
          fi
      
      - name: Cloner le WIKI
        if: steps.check-wiki.outputs.wiki_exists == 'true'
        run: |
          REPO="${{ github.repository }}"
          WIKI_REPO="${REPO}.wiki"
          WIKI_DIR=$(mktemp -d)
          echo "WIKI_DIR=${WIKI_DIR}" >> $GITHUB_ENV
          
          echo "ðŸ“¥ Clonage du WIKI..."
          git clone "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${WIKI_REPO}.git" "$WIKI_DIR" || {
            echo "ðŸ“ Initialisation d'un nouveau WIKI..."
            mkdir -p "$WIKI_DIR"
            cd "$WIKI_DIR"
            git init
            git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${WIKI_REPO}.git"
          }
      
      - name: Synchroniser les pages
        if: steps.check-wiki.outputs.wiki_exists == 'true'
        run: |
          echo "ðŸ”„ Synchronisation des pages..."
          
          UPDATED=0
          CREATED=0
          
          # Copier toutes les pages du dossier wiki/ vers le WIKI
          for page in wiki/*.md; do
            if [ -f "$page" ]; then
              page_name=$(basename "$page")
              
              # Ignorer README.md du dossier wiki
              if [ "$page_name" = "README.md" ]; then
                continue
              fi
              
              if [ -f "$WIKI_DIR/$page_name" ]; then
                # VÃ©rifier si le contenu a changÃ©
                if ! cmp -s "$page" "$WIKI_DIR/$page_name"; then
                  cp "$page" "$WIKI_DIR/$page_name"
                  echo "  âœï¸  Mise Ã  jour: $page_name"
                  ((UPDATED++))
                else
                  echo "  âœ“  DÃ©jÃ  Ã  jour: $page_name"
                fi
              else
                cp "$page" "$WIKI_DIR/$page_name"
                echo "  âž• CrÃ©ation: $page_name"
                ((CREATED++))
              fi
            fi
          done
          
          echo "UPDATED=${UPDATED}" >> $GITHUB_ENV
          echo "CREATED=${CREATED}" >> $GITHUB_ENV
      
      - name: Commit et push les changements
        if: steps.check-wiki.outputs.wiki_exists == 'true' && (env.UPDATED > 0 || env.CREATED > 0)
        run: |
          cd "$WIKI_DIR"
          
          # VÃ©rifier s'il y a des changements
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ Commit des changements..."
            git add -A
            
            COMMIT_MSG="ðŸ”„ Synchronisation automatique du WIKI
            
            - Mise Ã  jour depuis le dÃ©pÃ´t principal
            - Commit source: ${{ github.sha }}
            - Workflow: ${{ github.workflow }}
            - DÃ©clenchÃ© par: ${{ github.actor }}
            - Date: $(date -Iseconds)"
            
            git commit -m "$COMMIT_MSG" || exit 0
            
            # DÃ©terminer la branche par dÃ©faut
            DEFAULT_BRANCH="main"
            if ! git ls-remote --heads origin "$DEFAULT_BRANCH" | grep -q "$DEFAULT_BRANCH"; then
              DEFAULT_BRANCH="master"
            fi
            
            echo "ðŸ“¤ Push vers GitHub..."
            git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git" HEAD:$DEFAULT_BRANCH
            
            echo "âœ… WIKI synchronisÃ© avec succÃ¨s!"
            echo "   - Pages mises Ã  jour: ${UPDATED}"
            echo "   - Pages crÃ©Ã©es: ${CREATED}"
          else
            echo "â„¹ï¸  Aucun changement dÃ©tectÃ©"
          fi
      
      - name: Avertissement si le WIKI n'est pas activÃ©
        if: steps.check-wiki.outputs.wiki_exists == 'false'
        run: |
          echo "::warning::Le WIKI n'est pas activÃ© pour ce repository"
          echo "Activez-le dans: Settings > Features > Wikis"
          echo "Puis relancez ce workflow"
          exit 0  # Ne pas faire Ã©chouer le workflow
